<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics SDK 演示</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .section h3 {
            margin-top: 0;
            color: #495057;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .status {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .api-list {
            background: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .api-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .api-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 Analytics SDK 演示</h1>
        
        <!-- 用户信息设置 -->
        <div class="section">
            <h3>👤 用户信息设置</h3>
            <input type="text" id="userId" placeholder="输入用户ID" value="demo-user-123">
            <input type="text" id="userPlan" placeholder="用户计划" value="premium">
            <button onclick="updateUserInfo()">更新用户信息</button>
        </div>
        
        <!-- 页面追踪 -->
        <div class="section">
            <h3>📄 页面追踪</h3>
            <button onclick="trackCustomPage()">追踪自定义页面</button>
            <button onclick="simulatePageChange()">模拟页面跳转</button>
        </div>
        
        <!-- 用户操作追踪 -->
        <div class="section">
            <h3>🖱️ 用户操作追踪</h3>
            <button onclick="trackSearch()">搜索操作</button>
            <button onclick="trackPurchase()">购买操作</button>
            <button onclick="trackShare()">分享操作</button>
            <button onclick="throwError()">触发错误</button>
        </div>
        
        <!-- 表单交互 -->
        <div class="section">
            <h3>📝 表单交互</h3>
            <input type="text" placeholder="搜索关键词..." id="searchInput">
            <textarea placeholder="用户反馈..." id="feedbackText" rows="3"></textarea>
            <button onclick="submitForm()">提交表单</button>
        </div>
        
        <!-- API 调用模拟 -->
        <div class="section">
            <h3>🌐 API 调用模拟</h3>
            <button onclick="callGetAPI()">GET 请求</button>
            <button onclick="callPostAPI()">POST 请求</button>
            <button onclick="callFailAPI()">失败请求</button>
            
            <div class="api-list">
                <h4>API 调用记录：</h4>
                <div id="apiCalls"></div>
            </div>
        </div>
        
        <!-- 数据控制 -->
        <div class="section">
            <h3>⚙️ 数据控制</h3>
            <button onclick="flushData()">立即发送数据</button>
            <button onclick="clearStorage()">清空本地存储</button>
            <button onclick="showStatus()">显示状态</button>
        </div>
        
        <!-- 状态显示 -->
        <div class="status" id="status">
等待操作...

💡 提示：打开浏览器开发者工具查看详细的埋点数据
        </div>
    </div>

    <!-- 引入 SDK -->
    <script src="./dist/index.js"></script>
    
    <script>
        // 初始化 Analytics SDK
        const analytics = new Analytics({
            appId: 'demo-app',
            apiEndpoint: 'https://httpbin.org/post', // 使用 httpbin 作为测试接口
            debug: true,
            enablePV: true,
            enableUserTracking: true,
            enableClickTracking: true,
            enableApiTracking: true,
            enableErrorTracking: true,
            batchSize: 3,
            flushInterval: 10000,
            customUserInfo: {
                demo: true,
                environment: 'development'
            }
        });

        let apiCallCount = 0;

        // 更新状态显示
        function updateStatus(message) {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            status.textContent = `[${timestamp}] ${message}\n\n${status.textContent}`;
        }

        // 更新用户信息
        function updateUserInfo() {
            const userId = document.getElementById('userId').value;
            const userPlan = document.getElementById('userPlan').value;
            
            analytics.setUserId(userId);
            analytics.setUserInfo({
                customProperties: {
                    plan: userPlan,
                    demo: true,
                    lastUpdate: new Date().toISOString()
                }
            });
            
            updateStatus(`用户信息已更新: ID=${userId}, Plan=${userPlan}`);
        }

        // 追踪自定义页面
        function trackCustomPage() {
            analytics.trackPageView('/demo/custom-page', '自定义演示页面');
            updateStatus('已追踪自定义页面访问');
        }

        // 模拟页面跳转
        function simulatePageChange() {
            const pages = [
                { url: '/home', title: '首页' },
                { url: '/products', title: '产品页' },
                { url: '/about', title: '关于我们' },
                { url: '/contact', title: '联系我们' }
            ];
            
            const randomPage = pages[Math.floor(Math.random() * pages.length)];
            analytics.trackPageView(randomPage.url, randomPage.title);
            updateStatus(`模拟访问页面: ${randomPage.title} (${randomPage.url})`);
        }

        // 追踪搜索操作
        function trackSearch() {
            const keywords = ['analytics', 'tracking', '埋点', 'dashboard', 'data'];
            const keyword = keywords[Math.floor(Math.random() * keywords.length)];
            
            analytics.trackAction('search', {
                keyword: keyword,
                source: 'demo',
                resultsCount: Math.floor(Math.random() * 100)
            });
            
            updateStatus(`已追踪搜索操作: "${keyword}"`);
        }

        // 追踪购买操作
        function trackPurchase() {
            analytics.trackAction('purchase', {
                productId: 'demo-product-' + Math.floor(Math.random() * 1000),
                amount: (Math.random() * 1000).toFixed(2),
                currency: 'CNY',
                paymentMethod: 'credit_card'
            });
            
            updateStatus('已追踪购买操作');
        }

        // 追踪分享操作
        function trackShare() {
            const platforms = ['wechat', 'weibo', 'qq', 'twitter', 'facebook'];
            const platform = platforms[Math.floor(Math.random() * platforms.length)];
            
            analytics.trackAction('share', {
                platform: platform,
                content: 'Analytics SDK Demo',
                url: window.location.href
            });
            
            updateStatus(`已追踪分享操作: ${platform}`);
        }

        // 触发错误
        function throwError() {
            try {
                // 故意触发错误
                throw new Error('这是一个演示错误: ' + Date.now());
            } catch (error) {
                analytics.trackError(error, 'custom');
                updateStatus('已触发并追踪错误');
            }
        }

        // 提交表单
        function submitForm() {
            const searchKeyword = document.getElementById('searchInput').value;
            const feedback = document.getElementById('feedbackText').value;
            
            analytics.trackAction('form_submit', {
                formType: 'demo_form',
                searchKeyword: searchKeyword,
                feedbackLength: feedback.length,
                hasSearch: !!searchKeyword,
                hasFeedback: !!feedback
            });
            
            updateStatus(`已追踪表单提交: 搜索="${searchKeyword}", 反馈长度=${feedback.length}`);
        }

        // 模拟 GET API 调用
        async function callGetAPI() {
            try {
                const response = await fetch('https://jsonplaceholder.typicode.com/posts/1');
                const data = await response.json();
                
                addAPICall('GET', '/posts/1', response.status, 'success');
                updateStatus('GET API 调用成功');
            } catch (error) {
                addAPICall('GET', '/posts/1', 0, 'error');
                updateStatus('GET API 调用失败');
            }
        }

        // 模拟 POST API 调用
        async function callPostAPI() {
            try {
                const response = await fetch('https://jsonplaceholder.typicode.com/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: 'Demo Post',
                        body: 'This is a demo post from Analytics SDK',
                        userId: 1
                    })
                });
                
                const data = await response.json();
                addAPICall('POST', '/posts', response.status, 'success');
                updateStatus('POST API 调用成功');
            } catch (error) {
                addAPICall('POST', '/posts', 0, 'error');
                updateStatus('POST API 调用失败');
            }
        }

        // 模拟失败的 API 调用
        async function callFailAPI() {
            try {
                const response = await fetch('https://nonexistent-api.example.com/fail');
                addAPICall('GET', '/fail', response.status, 'success');
            } catch (error) {
                addAPICall('GET', '/fail', 0, 'error');
                updateStatus('API 调用失败（预期）');
            }
        }

        // 添加 API 调用记录到页面
        function addAPICall(method, url, status, result) {
            apiCallCount++;
            const apiCalls = document.getElementById('apiCalls');
            const callDiv = document.createElement('div');
            callDiv.className = 'api-item';
            callDiv.innerHTML = `
                <span>${apiCallCount}. ${method} ${url}</span>
                <span style="color: ${result === 'success' ? 'green' : 'red'}">
                    ${status} ${result}
                </span>
            `;
            apiCalls.insertBefore(callDiv, apiCalls.firstChild);
        }

        // 立即发送数据
        async function flushData() {
            await analytics.flush();
            updateStatus('已立即发送所有缓存数据');
        }

        // 清空本地存储
        function clearStorage() {
            localStorage.removeItem('analytics_user_id');
            localStorage.removeItem('analytics_session_id');
            localStorage.removeItem('analytics_session_time');
            updateStatus('已清空本地存储，刷新页面后将生成新的用户和会话ID');
        }

        // 显示当前状态
        function showStatus() {
            const userId = localStorage.getItem('analytics_user_id');
            const sessionId = localStorage.getItem('analytics_session_id');
            const sessionTime = localStorage.getItem('analytics_session_time');
            
            const statusInfo = {
                userId: userId,
                sessionId: sessionId,
                sessionStartTime: sessionTime ? new Date(parseInt(sessionTime)).toLocaleString() : 'N/A',
                pageTitle: document.title,
                pageUrl: window.location.href,
                userAgent: navigator.userAgent.substring(0, 50) + '...'
            };
            
            updateStatus('当前状态:\n' + JSON.stringify(statusInfo, null, 2));
        }

        // 页面加载完成后的初始化
        window.addEventListener('load', () => {
            updateStatus('Analytics SDK 演示页面已加载');
            updateStatus('自动追踪功能已启用：页面访问、点击事件、API调用、错误监控');
        });

        // 监听页面卸载，发送最终数据
        window.addEventListener('beforeunload', () => {
            analytics.flush();
        });
    </script>
</body>
</html>
